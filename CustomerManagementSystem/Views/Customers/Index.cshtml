@model CustomerReportDto

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}
<style>
    td.editable-active {
        background-color: #e8f0fe;
        border: 1px solid #1a73e8;
        box-shadow: inset 0 0 0 1px #1a73e8;
        cursor: text;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Customer List</h4>

    <!-- User + Admin can create -->
    <a asp-controller="Customers"
       asp-action="Create"
       class="btn btn-success">
        + Create Customer
    </a>
</div>
<form method="get" asp-action="Index" class="mb-3">
    <div class="input-group">
        <input type="text"
               name="search"
               value="@Model.Search"
               class="form-control"
               placeholder="Search by name, email or phone" />

        <button class="btn btn-primary" type="submit">
            Search
        </button>
    </div>
</form>

<table class="table table-bordered table-hover">
    <thead class="table-dark">
        <tr>
            <th>First</th>
            <th>Last</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Country</th>

            @if (User.IsInRole("Admin"))
            {
                <th>Actions</th>
            }
        </tr>
    </thead>

    <tbody>
        @foreach (var c in Model.Customers)
        {
            <tr data-id="@c.CustomerID">
                <td data-field="FirstName">@c.FirstName</td>
                <td data-field="LastName">@c.LastName</td>
                <td data-field="Email">@c.Email</td>
                <td data-field="Phone">@c.Phone</td>
                <td>@c.CountryName</td>

                @if (User.IsInRole("Admin"))
                {
                    <td>
                        <button class="btn btn-sm btn-primary btn-edit">Update</button>
                        <button class="btn btn-sm btn-danger btn-delete">Delete</button>
                    </td>
                }
            </tr>
        }
    </tbody>
</table>
<nav>
    <ul class="pagination justify-content-center">

        <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
            <a class="page-link"
               asp-action="Index"
               asp-route-page="@(Model.CurrentPage - 1)">
                Previous
            </a>
        </li>

        @for (int i = 1; i <= Model.TotalPages; i++)
        {
            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-page="@i">
                    @i
                </a>
            </li>
        }

        <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
            <a class="page-link"
               asp-action="Index"
               asp-route-page="@(Model.CurrentPage + 1)">
                Next
            </a>
        </li>

    </ul>
</nav>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

     $('.btn-edit').click(function () {

        var btn = $(this);
        var row = btn.closest('tr');
        var isEditMode = btn.text() === 'Update';

        if (isEditMode) {

            row.find('[data-field]')
                .attr('contenteditable', 'true')
                .addClass('editable-active');

            btn.text('Save')
               .removeClass('btn-primary')
               .addClass('btn-success');
        }
        else {

            var customer = {
                CustomerID: row.data('id'),
                FirstName: row.find('[data-field="FirstName"]').text().trim(),
                LastName: row.find('[data-field="LastName"]').text().trim(),
                Phone: row.find('[data-field="Phone"]').text().trim(),
                Email: row.find('[data-field="Email"]').text().trim()
            };

            $.ajax({
                url: '/Admin/Update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(customer),
                success: function () {


                    row.find('[data-field]')
                        .removeAttr('contenteditable')
                        .removeClass('editable-active');

                    btn.text('Update')
                       .removeClass('btn-success')
                       .addClass('btn-primary');
                },
                error: function () {
                    alert('Update failed');
                }
            });
        }
    });


    $('.btn-delete').click(function () {

        if (!confirm('Are you sure?')) return;

        var row = $(this).closest('tr');
        var id = row.data('id');

        $.ajax({
            url: '/Admin/Delete',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(id),
            success: function () {
                row.fadeOut(300, function () {
                    $(this).remove();
                });
            },
            error: function () {
                alert('Delete failed');
            }
        });
    });
</script>
